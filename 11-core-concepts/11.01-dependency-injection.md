# FastAPI Dependencies: A Complete Guide

## What Are Dependencies?

**Dependencies** in FastAPI are reusable pieces of code that can be injected into your endpoint functions. They help you:

- Avoid code repetition
- Share logic across multiple endpoints
- Manage resources (like database connections)
- Handle authentication and authorization
- Validate requests

Think of dependencies as "helpers" that FastAPI automatically calls before running your endpoint.

---

## Why Use Dependencies?

### Without Dependencies (❌ Repetitive Code)

```python
@app.get("/users/")
async def get_users():
    db = SessionLocal()
    try:
        users = db.query(User).all()
        return users
    finally:
        db.close()

@app.get("/posts/")
async def get_posts():
    db = SessionLocal()  # Same code repeated!
    try:
        posts = db.query(Post).all()
        return posts
    finally:
        db.close()
```

### With Dependencies (✅ Clean & Reusable)

```python
# Define dependency once
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# Use it everywhere
@app.get("/users/")
async def get_users(db: Session = Depends(get_db)):
    return db.query(User).all()

@app.get("/posts/")
async def get_posts(db: Session = Depends(get_db)):
    return db.query(Post).all()
```

---

## Common Use Cases

### 1. Database Connection

```python
from fastapi import Depends
from sqlalchemy.orm import Session

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.get("/users/")
async def get_users(db: Session = Depends(get_db)):
    return db.query(User).all()
```

### 2. Authentication

```python
def get_current_user(token: str = Depends(oauth2_scheme)):
    # Verify token and return user
    user = verify_token(token)
    if not user:
        raise HTTPException(status_code=401, detail="Invalid token")
    return user

@app.get("/profile/")
async def get_profile(current_user: User = Depends(get_current_user)):
    return {"username": current_user.username}
```

### 3. Type Alias (Cleaner Code)

```python
# Instead of writing this everywhere:
async def endpoint(db: Session = Depends(get_db)):
    pass

# Create a type alias:
db_dependency = Annotated[Session, Depends(get_db)]

# Now use it:
async def endpoint(db: db_dependency):
    pass
```

---

## How FastAPI Processes Parameters

FastAPI processes parameters in a **specific order**:

### 1. Path Parameters

```python
@app.get("/users/{user_id}")
async def get_user(user_id: int):  # ← Path parameter
    pass
```

### 2. Dependencies

```python
@app.get("/users/")
async def get_users(db: Session = Depends(get_db)):  # ← Dependency
    pass
```

### 3. Query Parameters

```python
@app.get("/users/")
async def get_users(skip: int = 0, limit: int = 10):  # ← Query params
    pass
# Called as: /users/?skip=0&limit=10
```

### 4. Request Body

```python
@app.post("/users/")
async def create_user(user: UserCreate):  # ← Request body
    pass
```

---

## The Order Rule: Why It Matters

### ❌ WRONG ORDER (Error!)

```python
@app.get("/callback")
async def auth_google(code: str = None, db: Session = Depends(get_db)):
    pass
```

**Error:** `SyntaxError: non-default argument follows default argument`

### ✅ CORRECT ORDER

```python
@app.get("/callback")
async def auth_google(db: Session = Depends(get_db), code: str = None):
    pass
```

### Why?

Python requires **non-default parameters** to come **before default parameters**:

```python
# ❌ Python Error
def func(a=1, b):  # Can't put non-default 'b' after default 'a'
    pass

# ✅ Python Correct
def func(b, a=1):  # Non-default first, then defaults
    pass
```

Even though `db: Session = Depends(get_db)` looks like it has a default, **FastAPI treats dependencies as non-default parameters internally**. So they must come before optional query parameters.

---

## Complete Example

```python
from fastapi import FastAPI, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import Annotated

app = FastAPI()

# 1. Define dependency
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# 2. Create type alias
db_dependency = Annotated[Session, Depends(get_db)]

# 3. Use in endpoints with correct order
@app.get("/users/{user_id}")
async def get_user(
    user_id: int,              # 1. Path parameter
    db: db_dependency,         # 2. Dependency
    include_posts: bool = False # 3. Query parameter
):
    user = db.query(User).filter(User.id == user_id).first()
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    return user

@app.post("/users/")
async def create_user(
    db: db_dependency,         # 1. Dependency (no path params here)
    user_data: UserCreate      # 2. Request body
):
    new_user = User(**user_data.dict())
    db.add(new_user)
    db.commit()
    return new_user
```

---

## Key Takeaways

1. **Dependencies = Reusable code** that FastAPI automatically injects
2. **Always put dependencies BEFORE optional parameters**
3. **Use type aliases** (`db_dependency`) for cleaner code
4. **Dependencies run automatically** before your endpoint function
5. **Order matters:** Path → Dependencies → Query → Body

---

## Common Patterns

### Pattern 1: Chained Dependencies

```python
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def get_current_user(db: Session = Depends(get_db), token: str = Depends(oauth2_scheme)):
    # This dependency uses another dependency (get_db)
    return verify_token(db, token)

@app.get("/profile/")
async def profile(user: User = Depends(get_current_user)):
    # get_current_user automatically calls get_db
    return user
```

### Pattern 2: Optional Dependencies

```python
def get_optional_user(token: str = None):
    if token:
        return verify_token(token)
    return None

@app.get("/posts/")
async def get_posts(user: User = Depends(get_optional_user)):
    # user can be None if no token provided
    if user:
        return get_user_posts(user)
    return get_public_posts()
```

---

## Resources

- [FastAPI Dependencies Documentation](https://fastapi.tiangolo.com/tutorial/dependencies/)

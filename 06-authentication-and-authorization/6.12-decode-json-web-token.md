## Decode a JSON Web Token

In the previous section, we generated and returned a JWT when users logged in. Now we need to decode that token when it is sent back by the client in order to **authenticate the current user**.

### Step 1: Import Dependencies

At the top of `auth.py`, add:

```python
from jose import JWTError, jwt
from fastapi.security import OAuth2PasswordBearer
```

### Step 2: Define OAuth2PasswordBearer

```python
oauth2_bearer = OAuth2PasswordBearer(tokenUrl="token")
```

- This tells FastAPI that the client will send the token using the **Authorization header** in the format:

  ```
  Authorization: Bearer <token>
  ```

- The `tokenUrl="token"` refers to our `/token` endpoint (where clients obtain tokens).

### Step 3: Decode the Token

We create a dependency function `get_current_user` that will:

1. Accept the token from the request header.
2. Decode it with the secret key and algorithm.
3. Extract the `sub` (username) and `id` (user ID).
4. If the token is invalid or missing information, raise a 401 Unauthorized error.

```python
async def get_current_user(token: Annotated[str, Depends(oauth2_bearer)]):
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        user_id: int = payload.get("id")
        if username is None or user_id is None:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Could not validate user"
            )
        return {"username": username, "id": user_id}

    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Could not validate user"
        )
```

- **`jwt.decode(...)`**: Verifies the token’s signature and decodes its contents.
- **`payload.get("sub")`**: Extracts the username (we set this when creating the token).
- **`payload.get("id")`**: Extracts the user ID.
- If either value is missing → we raise a **401 Unauthorized** error.
- If the token is invalid or expired → we also raise a **401 Unauthorized** error.

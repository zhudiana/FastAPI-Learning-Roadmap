## User Router (Get profile & Change password)

We are going to create a user router so that we can be able to get the logged in user information and let user change their password.

create a file called `user.py` inside routers package.

This router is mounted under `/user` and requires a valid JWT (via `get_current_user`). It uses a DB session dependency and `bcrypt` for secure password verification & hashing.

### Dependencies & Models (quick recap)

- **`user_dependency = Depends(get_current_user)`**
  Injects the current user from the JWT as a dict like `{"username": ..., "id": ...}`.

- **`db_dependency = Depends(get_db)`**
  Opens a SQLAlchemy session for the request and closes it after.

- **`UserVerification` (Pydantic model)**

  ```python
  class UserVerification(BaseModel):
      password: str
      new_password: str = Field(min_length=6)
  ```

  Validates the current password and the new password (min length 6).

- **`bcrypt_context`**
  Verifies the current password and hashes the new one.

---

### GET `/user/` ‚Äî Get logged-in user

```python
@router.get("/", status_code=status.HTTP_200_OK)
def get_user(user: user_dependency, db: db_dependency):
    if user is None:
        raise HTTPException(status_code=401, detail="Authentication Failed")
    return db.query(Users).filter(Users.id == user.get('id')).first()
```

**What it does**

- Ensures the request is authenticated (JWT required).
- Looks up the user in the DB by `id` from the token.
- Returns the **current user‚Äôs record**.

**Errors**

- `401 Authentication Failed` if no/invalid token.
- (If the user ID doesn‚Äôt exist anymore, the query returns `None`.)

---

### PUT `/user/change_password` ‚Äî Change password

```python
@router.put("/change_password", status_code=status.HTTP_204_NO_CONTENT)
def change_password(user: user_dependency, db: db_dependency, user_verification: UserVerification ):
    if user is None:
        raise HTTPException(status_code=401, detail="Authentication Failed")
    user_model = db.query(Users).filter(Users.id == user.get('id')).first()

    if not bcrypt_context.verify(user_verification.password, user_model.hashed_password):
        raise HTTPException(status_code=401, detail="Error on password change")

    user_model.hashed_password = bcrypt_context.hash(user_verification.new_password)

    db.add(user_model)
    db.commit()
```

**What it does**

- Requires a valid JWT (must be logged in).
- Fetches the current user from the DB.
- **Verifies** the provided current password (`user_verification.password`) using bcrypt.
- If correct, **hashes** `new_password` and updates the stored `hashed_password`.
- Commits the change and returns **204 No Content** (success, no body).

**Errors**

- `401 Authentication Failed` if not authenticated.
- `401 Error on password change` if the current password is wrong.

### üìù Notes

- These endpoints return/modify the **current authenticated user** only, no user ID is passed in the path.
- Because passwords are hashed with bcrypt, the server never stores or compares plain text passwords.

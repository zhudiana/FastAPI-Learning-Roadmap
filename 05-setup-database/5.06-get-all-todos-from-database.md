## Get All To-Dos From Database

In this section, we’ll learn how to **fetch all the todos** stored in our SQLite database using FastAPI and SQLAlchemy.

We’ll define a **dependency** that manages the database session, and then use it in our GET endpoint so that we don’t repeat code across multiple routes.

```python
from typing import Annotated
from fastapi import Depends, FastAPI
from sqlalchemy.orm import Session
import models
from models import Todos
from database import SessionLocal, engine

app = FastAPI()

# Create all tables from our models
models.Base.metadata.create_all(bind=engine)

# Dependency function to manage DB connection
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# Reusable DB dependency annotation
db_dependency = Annotated[Session, Depends(get_db)]

# GET endpoint to return all todos
@app.get("/")
def read_all(db: db_dependency):
    return db.query(Todos).all()
```

### 1. `models.Base.metadata.create_all(bind=engine)`

- Creates all the database tables defined in our `models.py`.
- If the `todos` table does not exist, this line will generate it inside our `Todoist.db` file.

### 2. `def get_db(): ...`

This function is our **database dependency**.

- `db = SessionLocal()` → creates a new database session.
- `try: yield db` → gives this session to whatever function needs it (our API endpoint).
- `finally: db.close()` → once the request is done, the session is closed to free resources.

This pattern makes sure the database connection is **opened and closed safely** for every request.

### 3. `db_dependency = Annotated[Session, Depends(get_db)]`

- This defines a **dependency** we can reuse.
- **Dependency** = a function that provides something our route needs (in this case, a DB session).
- Instead of creating a session in every endpoint, we just say “this route depends on `get_db`.”
- Using `Annotated` makes type hints clearer: FastAPI knows it should inject a `Session` into our function.

### 4. `@app.get("/")`

- Defines a GET endpoint at the root path `/`.
- When a client requests `/`, FastAPI calls `read_all`.

### 5. `def read_all(db: db_dependency):`

- `db: db_dependency` → tells FastAPI: _“inject a database session here using `get_db`.”_
- Inside the function, we can use `db` to run queries.

### 6. `return db.query(Todos).all()`

- Runs a query on the `Todos` table.
- `.all()` → returns **all rows** as a list.
- FastAPI automatically serializes these rows into JSON and sends them back to the client.

### Why Use Dependencies?

- Without dependencies, we would have to manually create and close the database session in **every single endpoint**.
- With dependencies, we **write once** and reuse everywhere.
- This makes our code:

  - Cleaner
  - Easier to test
  - Less error-prone

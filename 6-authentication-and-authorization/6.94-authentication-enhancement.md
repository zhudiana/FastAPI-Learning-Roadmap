## Authentication Enhancement

In this section, we organize our authentication into a router with a prefix and tags and give you the current code overview of our project.

### What the Code Does

### 1) Router setup

```python
router = APIRouter(
    prefix='/auth',
    tags=['auth']
)
```

- Adds a common path prefix (`/auth`) to all routes here.
- Groups these endpoints under the **auth** tag in Swagger UI.

### 2) Security configuration

- `SECRET_KEY`, `ALGORITHM` → used to sign/verify JWTs.
- `bcrypt_context` → hashes and verifies passwords using **bcrypt**.
- `oauth2_bearer = OAuth2PasswordBearer(tokenUrl='auth/token')`
  Tells FastAPI to expect a Bearer token and where clients obtain it (our `/auth/token` endpoint).

### 3) Pydantic models

```python
class CreateUserRequest(BaseModel): ...
class Token(BaseModel):
    access_token: str
    token_type: str
```

- `CreateUserRequest` validates incoming user creation data.
- `Token` defines the structure of the login response.

### 4) DB dependency

```python
def get_db(): ...
db_dependency = Annotated[Session, Depends(get_db)]
```

- Opens a DB session, yields it to the endpoint, and guarantees it closes after the request.

### 5) Authentication helpers

```python
def authenticate_user(username: str, password: str, db): ...
```

- Looks up the user by `username`.
- Verifies the raw password against the stored `hashed_password`.
- Returns the **user** on success, or `False` on failure.

```python
def create_access_token(username: str, user_id: int, expires_delta: timedelta): ...
```

- Creates a JWT with:

  - `sub` → username
  - `id` → user id
  - `exp` → expiration time

- Signs it with `SECRET_KEY` and `ALGORITHM`.

### 6) Decode current user from token

```python
async def get_current_user(token: Annotated[str, Depends(oauth2_bearer)]): ...
```

- Extracts the Bearer token from the `Authorization` header.
- Decodes and validates the JWT.
- Returns a simple dict `{ "username": ..., "id": ... }`.
- Raises **401 Unauthorized** if invalid or missing fields.

### 7) Endpoints

#### Create user

```python
@router.post("/", status_code=status.HTTP_201_CREATED)
def create_user(db: db_dependency, create_user_request: CreateUserRequest):
    ...
```

- Hashes the incoming password with `bcrypt_context.hash(...)`.
- Saves the new user to the database.
- Returns **201 Created** on success.

#### Login (issue token)

```python
@router.post("/token", response_model=Token)
def login_for_access_token(form_data: Annotated[OAuth2PasswordRequestForm, Depends()], db: db_dependency):
    ...
```

- Uses `OAuth2PasswordRequestForm` to read `username` and `password` from the request.
- Validates credentials via `authenticate_user`.
- On success, creates a JWT (20-minute expiry) and returns:

  ```json
  { "access_token": "<jwt>", "token_type": "Bearer" }
  ```

- On failure, raises **401 Unauthorized**.
